<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - WasteSense</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 26px;
            font-weight: 700;
            color: #212529;
        }
        .stat-sub {
            font-size: 12px;
            color: #6c757d;
            margin-top: 6px;
        }
        .table-small th,
        .table-small td {
            font-size: 14px;
            padding: 8px;
        }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">Logout</button>

    <div class="dashboard">
        <div class="dashboard-header">
            <h1>Analytics & Overview</h1>
            <p>High-level view of submissions and pending collections</p>
        </div>

        <nav class="nav-menu">
            <ul>
                <li><a href="dashboard-admin.html">‚Üê Back to Dashboard</a></li>
                <li><a href="admin-analytics.html">Analytics</a></li>
                <li><a href="admin-performance.html">Performance</a></li>
            </ul>
        </nav>

        <div class="content-section">
            <h2>Key Metrics</h2>
            <div id="alert-container"></div>
            <div class="cards-grid">
                <div class="stat-card">
                    <div class="stat-label">Pending Submissions</div>
                    <div class="stat-value" id="pendingCount">-</div>
                    <div class="stat-sub">Requests waiting for pickup</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Assigned to Collectors</div>
                    <div class="stat-value" id="assignedCount">-</div>
                    <div class="stat-sub">Scheduled for collection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Known Users</div>
                    <div class="stat-value" id="userCount">-</div>
                    <div class="stat-sub">Total registered accounts</div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2>Waste Mix (Pending + Assigned)</h2>
            <p style="font-size: 13px; color: #6c757d;">This gives a quick sense of what types of waste are currently in the queue.</p>
            <table class="locations-table table-small">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Approximate Count</th>
                    </tr>
                </thead>
                <tbody id="categoryBreakdownBody">
                    <tr>
                        <td colspan="2" style="text-align: center;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="content-section">
            <h2>Recent Pending Submissions</h2>
            <table class="locations-table table-small">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="pendingTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuthStatus();
            if (!user) {
                window.location.href = '/pages/login.html';
                return;
            }

            if (user.role !== 'admin') {
                alert('Access denied. Admin only.');
                window.location.href = '/pages/dashboard-resident.html';
                return;
            }

            const [pending, assigned] = await Promise.all([
                loadPendingSubmissions(),
                loadAssignedCount(),
                loadUserCount()
            ]);

            // Build simple category breakdown from pending + assigned submissions
            buildCategoryBreakdown(pending, assigned);
        });

        async function loadPendingSubmissions() {
            try {
                const response = await fetch('/api/waste/pending', { credentials: 'include' });
                const data = await response.json();
                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load pending submissions');
                }

                const submissions = data.data || [];
                document.getElementById('pendingCount').textContent = submissions.length;

                const tbody = document.getElementById('pendingTableBody');
                if (submissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No pending submissions.</td></tr>';
                    return;
                }

                const rows = submissions.slice(0, 10).map(s => `
                    <tr>
                        <td>${s.submission_id}</td>
                        <td>${s.collection_status}</td>
                        <td>${s.created_at ? new Date(s.created_at).toLocaleString() : ''}</td>
                        <td>${s.waste_description || '-'}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows;
                return submissions;
            } catch (error) {
                console.error(error);
                showAlert('Error loading pending submissions.', 'error');
                document.getElementById('pendingTableBody').innerHTML =
                    '<tr><td colspan="4" style="text-align: center;">Error loading data.</td></tr>';
                return [];
            }
        }

        async function loadAssignedCount() {
            try {
                const response = await fetch('/api/waste/assigned', { credentials: 'include' });
                const data = await response.json();
                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load assigned submissions');
                }
                const submissions = data.data || [];
                document.getElementById('assignedCount').textContent = submissions.length;
                return submissions;
            } catch (error) {
                console.error(error);
                document.getElementById('assignedCount').textContent = '-';
                return [];
            }
        }

        async function loadUserCount() {
            try {
                const response = await fetch('/api/users', { credentials: 'include' });
                const data = await response.json();
                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || 'Failed to load users');
                }
                const users = data.data || [];
                document.getElementById('userCount').textContent = users.length;
            } catch (error) {
                console.error(error);
                document.getElementById('userCount').textContent = '-';
            }
        }

        function buildCategoryBreakdown(pendingSubmissions, assignedSubmissions) {
            const all = [...pendingSubmissions, ...assignedSubmissions];
            const counts = {
                biodegradable: 0,
                'non-biodegradable': 0,
                recyclable: 0,
                special: 0,
                hazardous: 0,
                mixed: 0
            };

            all.forEach(s => {
                let types = [];
                if (s.waste_types) {
                    if (Array.isArray(s.waste_types)) {
                        types = s.waste_types;
                    } else if (typeof s.waste_types === 'string') {
                        try {
                            types = JSON.parse(s.waste_types);
                        } catch {
                            types = s.waste_types.split(',').map(t => t.trim()).filter(Boolean);
                        }
                    }
                } else if (s.confirmed_category || s.predicted_category) {
                    types = [s.confirmed_category || s.predicted_category];
                }

                if (types.length === 0) {
                    counts.mixed++;
                } else {
                    types.forEach(t => {
                        const key = t.toLowerCase();
                        if (counts[key] !== undefined) {
                            counts[key]++;
                        } else {
                            counts.mixed++;
                        }
                    });
                }
            });

            const tbody = document.getElementById('categoryBreakdownBody');
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">No active submissions to analyze.</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(counts)
                .filter(([, value]) => value > 0)
                .map(([category, value]) => `
                    <tr>
                        <td>${category.charAt(0).toUpperCase() + category.slice(1)}</td>
                        <td>${value}</td>
                    </tr>
                `)
                .join('');
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>

