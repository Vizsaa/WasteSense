<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Submissions - WasteSense</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .submissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .submission-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .submission-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .submission-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-scheduled {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-collected {
            background: #d4edda;
            color: #155724;
        }
        .submission-details {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .no-submissions {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .submission-actions {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn-cancel {
            background: #f8d7da;
            color: #721c24;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-cancel:hover {
            background: #f5c6cb;
        }
        .filter-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .filter-btn {
            padding: 6px 16px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background: #f0f0ff;
        }
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">Logout</button>
    
    <div class="dashboard">
        <div class="dashboard-header">
            <h1>My Waste Submissions</h1>
            <p>View and manage your waste collection requests</p>
        </div>

        <nav class="nav-menu">
            <ul>
                <li><a href="dashboard-resident.html">‚Üê Back to Dashboard</a></li>
                <li><a href="submit-waste.html">+ Submit New Waste</a></li>
            </ul>
        </nav>

        <div class="content-section">
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterSubmissions('all', this)">All</button>
                <button class="filter-btn" data-filter="pending" onclick="filterSubmissions('pending', this)">Pending</button>
                <button class="filter-btn" data-filter="scheduled" onclick="filterSubmissions('scheduled', this)">Scheduled</button>
                <button class="filter-btn" data-filter="collected" onclick="filterSubmissions('collected', this)">Collected</button>
            </div>
            <div id="submissionsContainer">
                <div class="no-submissions">
                    <p>Loading your submissions...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        let allSubmissions = []; // Cache for client-side filtering
        let activeFilter = 'all';

        // Check authentication
        window.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuthStatus();
            if (!user) {
                window.location.href = '/pages/login.html';
                return;
            }

            // Load submissions
            await loadSubmissions();
        });

        async function loadSubmissions() {
            try {
                const response = await fetch('/api/waste/my-submissions', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    allSubmissions = data.data || [];
                    applyFilter();
                } else {
                    document.getElementById('submissionsContainer').innerHTML = 
                        '<div class="no-submissions"><p>Error loading submissions. Please try again.</p></div>';
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissionsContainer').innerHTML = 
                    '<div class="no-submissions"><p>Error loading submissions. Please try again.</p></div>';
            }
        }

        function filterSubmissions(status, btn) {
            activeFilter = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilter();
        }

        function applyFilter() {
            const filtered = activeFilter === 'all'
                ? allSubmissions
                : allSubmissions.filter(s => (s.collection_status || 'pending') === activeFilter);
            displaySubmissions(filtered);
        }

        function displaySubmissions(submissions) {
            const container = document.getElementById('submissionsContainer');

            if (submissions.length === 0) {
                const isFiltered = activeFilter !== 'all';
                container.innerHTML = `
                    <div class="no-submissions">
                        <p>${isFiltered
                            ? `No ${activeFilter} submissions found.`
                            : "You haven't submitted any waste collection requests yet."}</p>
                        ${!isFiltered ? '<a href="submit-waste.html" class="btn" style="margin-top: 20px; display: inline-block;">Submit Your First Waste</a>' : ''}
                    </div>
                `;
                return;
            }

                const grid = document.createElement('div');
            grid.className = 'submissions-grid';

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'submission-card';

                const statusClass = `status-${submission.collection_status || 'pending'}`;
                const statusText = (submission.collection_status || 'pending').charAt(0).toUpperCase() + 
                                 (submission.collection_status || 'pending').slice(1);

                const imageHtml = submission.image_path ? 
                    `<img src="${submission.image_path}" alt="Waste image" class="submission-image">` : 
                    '<div style="height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 5px;">No Image</div>';

                // Parse waste types
                let wasteTypes = [];
                if (submission.waste_types) {
                    if (typeof submission.waste_types === 'string') {
                        try {
                            wasteTypes = JSON.parse(submission.waste_types);
                        } catch (e) {
                            wasteTypes = [];
                        }
                    } else if (Array.isArray(submission.waste_types)) {
                        wasteTypes = submission.waste_types;
                    }
                } else if (submission.confirmed_category || submission.predicted_category) {
                    wasteTypes = [submission.confirmed_category || submission.predicted_category];
                }

                // Parse waste adjectives
                let wasteAdjectives = [];
                if (submission.waste_adjectives) {
                    if (typeof submission.waste_adjectives === 'string') {
                        try {
                            wasteAdjectives = JSON.parse(submission.waste_adjectives);
                        } catch (e) {
                            wasteAdjectives = [];
                        }
                    } else if (Array.isArray(submission.waste_adjectives)) {
                        wasteAdjectives = submission.waste_adjectives;
                    }
                } else if (submission.waste_adjective) {
                    wasteAdjectives = [submission.waste_adjective];
                }

                const wasteTagsHtml = wasteTypes.length > 0 
                    ? wasteTypes.map(type => `<span style="display: inline-block; padding: 3px 10px; background: #e9ecef; color: #495057; border-radius: 15px; font-size: 11px; margin: 2px;">${type}</span>`).join('')
                    : '<span style="display: inline-block; padding: 3px 10px; background: #e9ecef; color: #495057; border-radius: 15px; font-size: 11px; margin: 2px;">Not specified</span>';

                const adjectiveTagsHtml = wasteAdjectives.length > 0 
                    ? wasteAdjectives.map(adj => `<span style="display: inline-block; padding: 3px 10px; background: #d1ecf1; color: #0c5460; border-radius: 15px; font-size: 11px; margin: 2px;">${adj}</span>`).join('')
                    : '<span style="display: inline-block; padding: 3px 10px; background: #e9ecef; color: #495057; border-radius: 15px; font-size: 11px; margin: 2px;">Not specified</span>';

                const canCancel = (submission.collection_status || 'pending') === 'pending';

                const confidenceHtml = submission.confidence_score != null
                    ? `<div class="submission-details"><strong>AI Confidence:</strong> ${parseFloat(submission.confidence_score).toFixed(0)}%</div>`
                    : '';
                const descHtml = submission.waste_description
                    ? `<div class="submission-details"><strong>Description:</strong> ${submission.waste_description}</div>`
                    : '';
                const addressHtml = submission.address_description
                    ? `<div class="submission-details"><strong>Address:</strong> ${submission.address_description}</div>`
                    : '';

                card.innerHTML = `
                    <span class="submission-status ${statusClass}">${statusText}</span>
                    ${imageHtml}
                    <div class="submission-details" style="margin-top: 10px;">
                        <strong>Waste Types:</strong><br>
                        <div style="margin-top: 5px;">${wasteTagsHtml}</div>
                    </div>
                    <div class="submission-details" style="margin-top: 10px;">
                        <strong>Adjectives:</strong><br>
                        <div style="margin-top: 5px;">${adjectiveTagsHtml}</div>
                    </div>
                    ${confidenceHtml}
                    ${descHtml}
                    ${submission.barangay_name ? `
                    <div class="submission-details">
                        <strong>Location:</strong> ${submission.barangay_name}, ${submission.municipality || ''}
                    </div>
                    ` : ''}
                    ${addressHtml}
                    <div class="submission-details">
                        <strong>Submitted:</strong> ${new Date(submission.created_at).toLocaleDateString()}
                    </div>
                    ${submission.scheduled_date ? `
                    <div class="submission-details">
                        <strong>Scheduled:</strong> ${new Date(submission.scheduled_date).toLocaleDateString()}
                    </div>
                    ` : ''}
                    <div class="submission-actions">
                        ${canCancel ? `<button class="btn-cancel" onclick="cancelSubmission(${submission.submission_id})">Cancel Submission</button>` : ''}
                    </div>
                `;

                grid.appendChild(card);
            });

                container.innerHTML = '';
                container.appendChild(grid);
        }

        async function cancelSubmission(submissionId) {
            if (!confirm('Are you sure you want to cancel this pending submission?')) {
                return;
            }

            try {
                const response = await fetch(`/api/waste/${submissionId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json().catch(() => ({}));

                if (response.ok && data.status === 'success') {
                    alert('Submission cancelled successfully.');
                    await loadSubmissions();
                } else {
                    alert(data.message || 'Failed to cancel submission. Please try again.');
                }
            } catch (error) {
                console.error('Error cancelling submission:', error);
                alert('An error occurred while cancelling. Please try again.');
            }
        }
    </script>
</body>
</html>
